<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>Inventory Admin</title><meta name="theme-color" content="#0ea5e9"/>
<style>
:root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#475569;--line:#e2e8f0;--accent:#0ea5e9;--shadow:0 8px 24px rgba(15,23,42,.06);--gap:12px}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
.wrap{max-width:720px;margin:0 auto;padding:12px}
h1{font-size:18px;margin:6px 0}.btns{display:flex;gap:8px;flex-wrap:wrap}
button,.btn{display:inline-flex;align-items:center;gap:8px;height:36px;padding:0 12px;border:1px solid var(--line);background:#fff;color:#0f172a;border-radius:12px;cursor:pointer}
.primary{background:var(--accent);color:#fff;border-color:transparent}
.panel{background:#fff;border-bottom:1px solid var(--line)}
.panel .inner{max-width:720px;margin:0 auto;padding:12px;display:grid;gap:10px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.field{display:flex;flex-direction:column;gap:6px}label{font-size:12px;color:var(--muted)}
input,select,textarea{border:1px solid var(--line);border-radius:12px;padding:10px;font-size:16px}
input,select{height:40px;padding:0 10px}textarea{min-height:90px;resize:vertical}
.photos{border:2px dashed #cbd5e1;border-radius:14px;padding:10px;background:#f8fafc}
.photos .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.thumb{position:relative;width:110px;height:82px;border-radius:10px;overflow:hidden;background:#e5e7eb}
.thumb img{width:100%;height:100%;object-fit:cover;display:block}
.thumb .x, .thumb .L, .thumb .R{position:absolute;bottom:6px;padding:2px 6px;border-radius:8px;font-size:12px;cursor:pointer;background:#fff;border:1px solid #e2e8f0}
.thumb .x{right:6px;color:#ef4444;border-color:#fecaca}
.thumb .L{left:6px}
.thumb .R{left:40px}
.addbox{display:inline-flex;align-items:center;justify-content:center;width:110px;height:82px;border:2px dashed #cbd5e1;border-radius:10px;background:#fff;color:#64748b;cursor:pointer}
.list{display:grid;grid-template-columns:1fr;gap:var(--gap);padding:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;position:relative}
.photo{width:100%;aspect-ratio:4/3;background:#e5e7eb}.photo img{width:100%;height:100%;object-fit:cover;display:block}
.info{padding:10px 12px 12px;display:flex;flex-direction:column;gap:6px}
.line{display:flex;align-items:baseline;justify-content:space-between;gap:10px;white-space:nowrap;overflow:hidden}
.title{font-weight:600;overflow:hidden;text-overflow:ellipsis}.miles{color:#475569}.price{font-weight:700}
.actions{position:absolute;top:8px;right:8px;display:flex;gap:6px}.small{height:30px;padding:0 10px;border-radius:10px}
.note{color:#475569;font-size:13px}
</style></head><body>
<header><div class="wrap"><h1>Inventory Admin</h1>
  <div class="btns">
    <a class="btn" href="./share.html">View site</a>
    <button id="shareBtn" class="btn">Share link</button>
    <button id="exportBtn">Export inventory.json</button>
    <label class="btn" for="importFile">Import</label><input id="importFile" type="file" accept="application/json" style="display:none"/>
    <button id="clearAllBtn" class="btn" style="color:#ef4444;border-color:#fecaca;">Clear all</button>
    <button id="publishBtn" class="primary">Publish to GitHub</button>
    <button id="settingsBtn" class="btn">⚙️ Settings</button>
  </div>
</div></header>

<section id="settings" style="display:none;background:#fff;border-top:1px solid #e2e8f0;border-bottom:1px solid #e2e8f0">
  <div class="wrap" style="display:grid;gap:10px">
    <div class="grid">
      <div class="field"><label>GitHub Username</label><input id="ghUser" placeholder="your-username"></div>
      <div class="field"><label>Repository</label><input id="ghRepo" placeholder="your-repo"></div>
      <div class="field"><label>Branch</label><input id="ghBranch" placeholder="main" value="main"></div>
      <div class="field"><label>File path</label><input id="ghPath" placeholder="inventory.json" value="inventory.json"></div>
      <div class="field" style="grid-column:span 2"><label>Fine-grained token (Contents: Read & Write)</label><input id="ghToken" type="password" placeholder="Paste token (not saved after tab closes)"></div>
    </div>
    <p class="note">Your token is used only by this browser via GitHub’s API. It lives in <b>sessionStorage</b> and clears when the tab closes.</p>
  </div>
</section>

<div class="panel"><div class="inner">
  <h2 style="font-size:16px;margin:0">Add / Edit</h2>
  <div class="grid">
    <div class="field"><label>Year</label><input id="year" placeholder="2020"></div>
    <div class="field"><label>Model</label>
      <select id="model"><option>Model 3</option><option>Model Y</option><option>Model S</option><option>Model X</option><option>Other</option></select>
    </div>
    <div class="field" style="grid-column:span 2"><label>Trim</label><input id="trim" placeholder="Standard Plus"></div>
    <div class="field"><label>Mileage</label><input id="mileage" placeholder="66000"></div>
    <div class="field"><label>Price (USD)</label><input id="price" placeholder="19000"></div>
    <div class="field" style="grid-column:span 2"><label>Notes (shown in modal)</label><textarea id="notes" placeholder="Clean title, FSD, new tires…"></textarea></div>
  </div>

  <div class="field">
    <label>Photos (up to 5) — click “+ Add photos” or drag & drop. Images auto-compress.</label>
    <div class="photos" id="photosDrop">
      <div class="row" id="thumbRow"></div>
      <div class="row" style="margin-top:8px">
        <label class="addbox" for="photosInput">+ Add photos</label>
        <input id="photosInput" type="file" accept="image/*" multiple style="display:none"/>
      </div>
      <p class="note" style="margin:8px 0 0">Tip: First image becomes the card thumbnail.</p>
    </div>
  </div>

  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button id="saveBtn" class="primary">Save</button>
    <button id="newBtn" class="btn">New</button>
    <button id="deleteBtn" class="btn" style="display:none;color:#ef4444;border-color:#fecaca;">Delete</button>
  </div>
</div></div>

<main><div class="wrap">
  <div id="list" class="list"></div>
  <p id="emptyState" class="note" style="text-align:center;margin:24px 0">No cars yet.</p>
</div></main>

<script>
const storeKey='tesla_inventory_v1'; let cars=load(); let editingId=null; let curPhotos=[];
const listEl=$('#list'), emptyEl=$('#emptyState');
const yearEl=$('#year'), modelEl=$('#model'), trimEl=$('#trim'), mileageEl=$('#mileage'), priceEl=$('#price'), notesEl=$('#notes');
const photosInput=$('#photosInput'), photosDrop=$('#photosDrop'), thumbRow=$('#thumbRow');
const saveBtn=$('#saveBtn'), newBtn=$('#newBtn'), delBtn=$('#deleteBtn');
const exportBtn=$('#exportBtn'), importFile=$('#importFile'), clearAllBtn=$('#clearAllBtn');
const publishBtn=$('#publishBtn'), settingsBtn=$('#settingsBtn'), settings=$('#settings');
const ghUser=$('#ghUser'), ghRepo=$('#ghRepo'), ghBranch=$('#ghBranch'), ghPath=$('#ghPath'), ghToken=$('#ghToken');
const shareBtn=$('#shareBtn');

function $(q){return document.querySelector(q)}
function load(){try{return JSON.parse(localStorage.getItem(storeKey)||'[]')}catch{return[]}}
function persist(){localStorage.setItem(storeKey, JSON.stringify(cars))}
function id(){return Math.random().toString(36).slice(2,10)}
function num(v){const s=String(v).replace(/[^0-9]/g,'');return s?parseInt(s,10):0}
function fmtPrice(n){try{return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(n)}catch{return '$'+(n||0)}}
function fmtMiles(n){try{return new Intl.NumberFormat('en-US').format(n)+' mi'}catch{return (n||0)+' mi'}}

function render(){ cars.sort((a,b)=>(a.addedAt||0)-(b.addedAt||0)||(a.year||0)-(b.year||0));
  listEl.innerHTML=''; if(!cars.length){ emptyEl.style.display='block'; return } emptyEl.style.display='none';
  for(const c of cars){ listEl.appendChild(card(c)) }
}
function card(c){ const el=document.createElement('div');el.className='card';
  const ph=document.createElement('div');ph.className='photo';
  const img=document.createElement('img'); img.src=(c.photos&&c.photos[0])||c.photo||placeholder(); img.alt=c.model; ph.appendChild(img);
  const info=document.createElement('div');info.className='info';
  const l1=document.createElement('div');l1.className='line';
  const title=document.createElement('div');title.className='title';title.textContent=`${c.year||''} ${c.model||''} ${c.trim||''}`.replace(/\s+/g,' ').trim();
  const miles=document.createElement('div');miles.className='miles';miles.textContent=fmtMiles(c.mileage||0);
  const l2=document.createElement('div');l2.className='line';l2.innerHTML=`<b class='price'>${fmtPrice(c.price||0)}</b><span style='font-size:12px;color:#475569'>${c.addedAt? new Date(c.addedAt).toLocaleDateString():''}</span>`;
  l1.appendChild(title);l1.appendChild(miles);info.appendChild(l1);info.appendChild(l2);
  const acts=document.createElement('div');acts.className='actions';
  const eB=btn('Edit',()=>openEdit(c.id)), dB=btn('Delete',()=>{ if(confirm('Delete this car?')){ cars=cars.filter(x=>x.id!==c.id); persist(); render(); if(editingId===c.id) resetForm(); }});
  dB.style.color='#ef4444'; dB.style.borderColor='#fecaca'; acts.appendChild(eB); acts.appendChild(dB);
  el.appendChild(ph);el.appendChild(info);el.appendChild(acts); el.addEventListener('click',()=>openEdit(c.id)); return el;
}
function btn(t,fn){const b=document.createElement('button');b.className='small';b.textContent=t;b.addEventListener('click',e=>{e.stopPropagation();fn()});return b}
function placeholder(){const s=`<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600' viewBox='0 0 800 600'><rect width='800' height='600' fill='#e5e7eb'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#94a3b8' font-family='system-ui' font-size='28'>Photo</text></svg>`;return'data:image/svg+xml;charset=utf-8,'+encodeURIComponent(s)}

function openEdit(i){ const c=cars.find(x=>x.id===i); if(!c) return; editingId=i;
  yearEl.value=c.year||''; modelEl.value=c.model||'Model 3'; trimEl.value=c.trim||''; mileageEl.value=c.mileage||''; priceEl.value=c.price||''; notesEl.value=c.notes||'';
  curPhotos = Array.isArray(c.photos)&&c.photos.length? [...c.photos] : (c.photo?[c.photo]:[]);
  renderThumbs(); delBtn.style.display='inline-flex'; window.scrollTo({top:0,behavior:'smooth'});
}
function resetForm(){ editingId=null; yearEl.value=''; modelEl.value='Model 3'; trimEl.value=''; mileageEl.value=''; priceEl.value=''; notesEl.value=''; curPhotos=[]; renderThumbs(); delBtn.style.display='none'; }

function renderThumbs(){ thumbRow.innerHTML='';
  curPhotos.forEach((src,idx)=>{ const th=document.createElement('div'); th.className='thumb';
    const im=document.createElement('img'); im.src=src; th.appendChild(im);
    const x=document.createElement('div'); x.className='x'; x.textContent='Del'; x.onclick=()=>{ curPhotos.splice(idx,1); renderThumbs(); };
    const L=document.createElement('div'); L.className='L'; L.textContent='←'; L.onclick=()=>{ if(idx>0){ const t=curPhotos[idx-1]; curPhotos[idx-1]=curPhotos[idx]; curPhotos[idx]=t; renderThumbs();}};
    const R=document.createElement('div'); R.className='R'; R.textContent='→'; R.onclick=()=>{ if(idx<curPhotos.length-1){ const t=curPhotos[idx+1]; curPhotos[idx+1]=curPhotos[idx]; curPhotos[idx]=t; renderThumbs();}};
    th.appendChild(x); th.appendChild(L); th.appendChild(R); thumbRow.appendChild(th);
  });
  while(thumbRow.children.length<1) { /* keep area visible even if empty */ const sp=document.createElement('div'); sp.style.height='0px'; thumbRow.appendChild(sp); break; }
}

photosInput.addEventListener('change', async e=>{ const files=[...e.target.files]; await addPhotos(files); e.target.value=''; });
['dragover','dragleave','drop'].forEach(ev=>photosDrop.addEventListener(ev,e=>{ if(ev!=='dragover') photosDrop.style.background='#f8fafc'; else photosDrop.style.background='#eef2ff'; e.preventDefault(); }));
photosDrop.addEventListener('drop', async e=>{ const files=[...e.dataTransfer.files]; await addPhotos(files); });

async function addPhotos(files){ for(const file of files){ if(!file.type.startsWith('image/')) continue;
    if(curPhotos.length>=5) { alert('Max 5 photos per car'); break; }
    const dataUrl = await compress(file,1200,0.86); curPhotos.push(dataUrl);
  } renderThumbs();
}
function toImg(file){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>{const i=new Image();i.onload=()=>res(i);i.onerror=rej;i.src=fr.result};fr.onerror=rej;fr.readAsDataURL(file)})}
async function compress(file,maxW=1200,quality=0.86){const img=await toImg(file);const scale=Math.min(1,maxW/img.width||1);const w=Math.round((img.width||maxW)*scale),h=Math.round((img.height||maxW*0.75)*scale);const c=document.createElement('canvas');c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);return c.toDataURL('image/jpeg',quality)}

async function onSave(){ const y=num(yearEl.value), m=modelEl.value, t=trimEl.value.trim(), mi=num(mileageEl.value), p=num(priceEl.value), n=notesEl.value.trim();
  if(!y){alert('Enter Year');yearEl.focus();return} if(!m){alert('Choose Model');return}
  if(!t){alert('Enter Trim');trimEl.focus();return} if(!mi){alert('Enter Mileage (numbers)');mileageEl.focus();return}
  if(!p){alert('Enter Price (numbers)');priceEl.focus();return}
  const photos=[...curPhotos].slice(0,5); const primary = photos[0]||'';
  if(!editingId){ cars.push({id:id(),year:y,model:m,trim:t,mileage:mi,price:p,notes:n,photos,photo:primary,addedAt:Date.now()}); }
  else{ const i=cars.findIndex(x=>x.id===editingId); if(i!==-1){ const prev=cars[i]; cars[i]={...prev,year:y,model:m,trim:t,mileage:mi,price:p,notes:n,photos,photo:primary}; } }
  persist(); render(); resetForm();
}
function onDelete(){ if(!editingId) return; if(!confirm('Delete this car?')) return; cars=cars.filter(x=>x.id!==editingId); persist(); render(); resetForm(); }

function exportJSON(){ const blob=new Blob([JSON.stringify(cars,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='inventory.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);}

importFile.addEventListener('change', async e=>{ const f=e.target.files[0]; if(!f) return; try{ const t=await f.text(); const data=JSON.parse(t); if(!Array.isArray(data)) throw 0; cars=data; persist(); render(); alert('Imported.') }catch{ alert('Import failed.') } e.target.value='' });
clearAllBtn.addEventListener('click',()=>{ if(!cars.length) return; if(!confirm('Clear ALL cars?')) return; cars=[]; persist(); render(); resetForm(); });
saveBtn.addEventListener('click',onSave); newBtn.addEventListener('click',resetForm); delBtn.addEventListener('click',onDelete); exportBtn.addEventListener('click',exportJSON);

settingsBtn.addEventListener('click',()=> settings.style.display = settings.style.display==='none' ? 'block':'none');
const cfgKey='tesla_inv_cfg';
function loadCfg(){try{return JSON.parse(localStorage.getItem(cfgKey)||'{}')}catch{return{}}}
function saveCfg(v){localStorage.setItem(cfgKey, JSON.stringify(v))}
function saveToken(t){sessionStorage.setItem('tesla_inv_token', t||'')}
function loadToken(){return sessionStorage.getItem('tesla_inv_token')||''}
(function init(){ const cfg=loadCfg(); ghUser.value=cfg.user||''; ghRepo.value=cfg.repo||''; ghBranch.value=cfg.branch||'main'; ghPath.value=cfg.path||'inventory.json'; ghToken.value=loadToken();
  [ghUser,ghRepo,ghBranch,ghPath].forEach(el=> el.addEventListener('change',()=>{ const c=loadCfg(); c.user=ghUser.value.trim(); c.repo=ghRepo.value.trim(); c.branch=ghBranch.value.trim()||'main'; c.path=ghPath.value.trim()||'inventory.json'; saveCfg(c); }));
  ghToken.addEventListener('change',()=> saveToken(ghToken.value.trim()));
})();
async function publish(){ try{
  const user=ghUser.value.trim(), repo=ghRepo.value.trim(), branch=(ghBranch.value.trim()||'main'), path=(ghPath.value.trim()||'inventory.json'); const token=ghToken.value.trim()||loadToken();
  if(!user||!repo||!token){ alert('Fill GitHub Username, Repo, and paste your token in Settings.'); settings.style.display='block'; return }
  const api='https://api.github.com', headers={'Authorization':'Bearer '+token,'Accept':'application/vnd.github+json'};
  const bodyStr=JSON.stringify(cars,null,2); const content=btoa(unescape(encodeURIComponent(bodyStr)));
  let sha=null; try{ const r=await fetch(`${api}/repos/${user}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`,{headers}); if(r.ok){ const j=await r.json(); sha=j.sha||null; } }catch{}
  const payload={message:'Update inventory via Admin',content,branch}; if(sha) payload.sha=sha;
  const r2=await fetch(`${api}/repos/${user}/${repo}/contents/${encodeURIComponent(path)}`,{method:'PUT',headers,body:JSON.stringify(payload)}); if(!r2.ok) throw new Error('GitHub API error: '+await r2.text());
  alert('Published to GitHub. Refresh your viewer.');
}catch(e){ alert(e.message||String(e));}}
publishBtn.addEventListener('click',publish);

// Share link button → always buyer link
shareBtn.addEventListener('click', async ()=>{
  const shareUrl = location.origin + location.pathname.replace(/[^/]+$/, '') + 'share.html';
  try{ if(navigator.share){ await navigator.share({title:'Current Inventory', url:shareUrl}); }
       else if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(shareUrl); alert('Link copied: '+shareUrl); }
       else { const el=document.createElement('input'); el.value=shareUrl; document.body.appendChild(el); el.select(); document.execCommand('copy'); el.remove(); alert('Link copied: '+shareUrl); }
  }catch{ alert('Copy this link:\n'+shareUrl); }
});

render();
</script></body></html>
