<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Inventory Admin</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#475569; --line:#e2e8f0; --accent:#0ea5e9; --shadow:0 8px 24px rgba(15,23,42,.06); --radius:16px; --gap:12px; }
    *{ box-sizing:border-box } body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial }
    header{ position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--line) } .wrap{ max-width:720px; margin:0 auto; padding:12px }
    h1{ font-size:18px; margin:6px 0 } .btns{ display:flex; gap:8px; flex-wrap:wrap } button,.btn{ display:inline-flex; align-items:center; gap:8px; height:36px; padding:0 12px; border:1px solid var(--line); background:#fff; color:#0f172a; border-radius:12px; cursor:pointer }
    .primary{ background:var(--accent); color:#fff; border-color:transparent }
    .panel{ background:#fff; border-bottom:1px solid var(--line) } .panel .inner{ max-width:720px; margin:0 auto; padding:12px; display:grid; gap:10px }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px } .field{ display:flex; flex-direction:column; gap:6px } label{ font-size:12px; color:var(--muted) }
    input,select{ height:40px; border:1px solid var(--line); border-radius:12px; padding:0 10px; font-size:16px }
    .drop{ position:relative; border:2px dashed #cbd5e1; border-radius:14px; padding:10px; min-height:160px; display:grid; place-items:center; background:#f8fafc }
    .drop input[type=file]{ position:absolute; inset:0; opacity:0; cursor:pointer } .drop .hint{ color:var(--muted); font-size:14px; text-align:center } .drop img{ max-width:100%; border-radius:10px; display:none }
    .list{ display:grid; grid-template-columns:1fr; gap:var(--gap); padding:12px } .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow); overflow:hidden; position:relative }
    .photo{ width:100%; aspect-ratio:4/3; background:#e5e7eb } .photo img{ width:100%; height:100%; object-fit:cover; display:block }
    .info{ padding:10px 12px 12px; display:flex; flex-direction:column; gap:6px } .line{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; white-space:nowrap; overflow:hidden }
    .title{ font-weight:600; overflow:hidden; text-overflow:ellipsis } .miles{ color:#475569 } .price{ font-weight:700 }
    .actions{ position:absolute; top:8px; right:8px; display:flex; gap:6px } .small{ height:30px; padding:0 10px; border-radius:10px }
    .settings{ background:#fff; border-top:1px solid var(--line); border-bottom:1px solid var(--line) }
    .settings .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:12px }
    .note{ color:#475569; font-size:13px; padding:0 12px 12px }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Inventory Admin</h1>
      <div class="btns">
        <button id="shareBtn" class="btn">Share link</button>
        <a class="btn" href="./index.html">View site</a>
        <button id="exportBtn">Export inventory.json</button>
        <label class="btn" for="importFile">Import</label><input id="importFile" type="file" accept="application/json" style="display:none"/>
        <button id="clearAllBtn" class="btn" style="color:#ef4444;border-color:#fecaca;">Clear all</button>
        <button id="publishBtn" class="primary">Publish to GitHub</button>
        <button id="settingsBtn" class="btn">⚙️ Settings</button>
      </div>
    </div>
  </header>

  <section id="settings" class="settings" style="display:none;">
    <div class="row">
      <div class="field"><label>GitHub Username</label><input id="ghUser" placeholder="your-username"></div>
      <div class="field"><label>Repository</label><input id="ghRepo" placeholder="your-repo"></div>
      <div class="field"><label>Branch</label><input id="ghBranch" placeholder="main" value="main"></div>
      <div class="field"><label>File path</label><input id="ghPath" placeholder="inventory.json" value="inventory.json"></div>
      <div class="field" style="grid-column: span 2;"><label>Fine-grained token (Contents: Read & Write)</label><input id="ghToken" type="password" placeholder="Paste token (not saved after tab closes)"></div>
    </div>
    <p class="note">Your token is used only from this browser to call the GitHub API. It is stored in <b>sessionStorage</b> (cleared when you close the tab). We never send it anywhere else.</p>
  </section>

  <div class="panel">
    <div class="inner">
      <h2 style="font-size:16px;margin:0">Add / Edit</h2>
      <div class="grid">
        <div class="field"><label>Year</label><input type="text" id="year" placeholder="2020" /></div>
        <div class="field"><label>Model</label><select id="model"><option>Model 3</option><option>Model Y</option><option>Model S</option><option>Model X</option><option>Other</option></select></div>
        <div class="field" style="grid-column: span 2;"><label>Trim</label><input type="text" id="trim" placeholder="Standard Plus" /></div>
        <div class="field"><label>Mileage</label><input type="text" id="mileage" placeholder="66000" /></div>
        <div class="field"><label>Price (USD)</label><input type="text" id="price" placeholder="19000" /></div>
      </div>
      <div class="field">
        <label>Photo (4:3 shown; auto-compress)</label>
        <div class="drop" id="drop">
          <input type="file" id="photoInput" accept="image/*" />
          <div class="hint" id="dropHint"><b>Click here</b> or drag & drop a photo.</div>
          <img id="photoPreview" alt="preview" />
        </div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="saveBtn" class="primary">Save</button>
        <button id="newBtn" class="btn">New</button>
        <button id="deleteBtn" class="btn" style="display:none;color:#ef4444;border-color:#fecaca;">Delete</button>
      </div>
      <p class="note">Tip: Keep photos moderate (under ~2–3 MB each). After updates, <b>Publish to GitHub</b> to push changes live in one click.</p>
    </div>
  </div>

  <main>
    <div id="list" class="list"></div>
    <p id="emptyState" class="note" style="text-align:center; margin:24px 0;">No cars yet.</p>
  </main>

  <script>
   <script>
// …your existing script…

// After your other querySelectors:
const shareBtn = document.getElementById('shareBtn');

// One-tap share/copy of your viewer page (share.html in same folder)
shareBtn.addEventListener('click', async () => {
  const shareUrl = new URL('share.html', location.href).href;
  try {
    if (navigator.share) {
      await navigator.share({ title: 'Current Inventory', url: shareUrl });
    } else if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(shareUrl);
      alert('Link copied: ' + shareUrl);
    } else {
      const el = document.createElement('input');
      el.value = shareUrl;
      document.body.appendChild(el);
      el.select();
      document.execCommand('copy');
      document.body.removeChild(el);
      alert('Link copied: ' + shareUrl);
    }
  } catch {
    alert('Could not open share sheet. Copy this link:\n' + shareUrl);
  }
});

// …keep the rest of your script
</script>
 const storeKey='tesla_inventory_v1'; let cars=load(); let editingId=null;
    const listEl=document.getElementById('list'), emptyEl=document.getElementById('emptyState');
    const yearEl=document.getElementById('year'), modelEl=document.getElementById('model'), trimEl=document.getElementById('trim'), mileageEl=document.getElementById('mileage'), priceEl=document.getElementById('price');
    const drop=document.getElementById('drop'), photoInput=document.getElementById('photoInput'), photoPreview=document.getElementById('photoPreview'), dropHint=document.getElementById('dropHint');
    const saveBtn=document.getElementById('saveBtn'), newBtn=document.getElementById('newBtn'), deleteBtn=document.getElementById('deleteBtn');
    const exportBtn=document.getElementById('exportBtn'), importFile=document.getElementById('importFile'), clearAllBtn=document.getElementById('clearAllBtn');
    const publishBtn=document.getElementById('publishBtn'), settingsBtn=document.getElementById('settingsBtn'), settings=document.getElementById('settings');
    const ghUser=document.getElementById('ghUser'), ghRepo=document.getElementById('ghRepo'), ghBranch=document.getElementById('ghBranch'), ghPath=document.getElementById('ghPath'), ghToken=document.getElementById('ghToken');

    function load(){ try{ return JSON.parse(localStorage.getItem(storeKey)||'[]'); } catch{ return []; } } function persist(){ localStorage.setItem(storeKey, JSON.stringify(cars)); }
    function id(){ return Math.random().toString(36).slice(2,10); }
    function num(v){ const s=String(v).replace(/[^0-9]/g,''); return s?parseInt(s,10):0; }
    function fmtPrice(n){ try{ return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(n);}catch{ return '$'+(n||0);} }
    function fmtMiles(n){ try{ return new Intl.NumberFormat('en-US').format(n)+' mi'; }catch{ return (n||0)+' mi'; } }
    function sortCars(){ cars.sort((a,b)=>(a.addedAt||0)-(b.addedAt||0)||(a.year||0)-(b.year||0)); }

    function render(){ sortCars(); listEl.innerHTML=''; if(!cars.length){ emptyEl.style.display='block'; return;} emptyEl.style.display='none'; cars.forEach(c=>listEl.appendChild(card(c))); }

    function card(c){ const el=document.createElement('div'); el.className='card';
      const ph=document.createElement('div'); ph.className='photo'; const img=document.createElement('img'); img.src=c.photo||placeholder(); img.alt=c.model; ph.appendChild(img);
      const info=document.createElement('div'); info.className='info';
      const line=document.createElement('div'); line.className='line'; const title=document.createElement('div'); title.className='title'; title.textContent=`${c.year||''} ${c.model||''} ${c.trim||''}`.replace(/\\s+/g,' ').trim();
      const miles=document.createElement('div'); miles.className='miles'; miles.textContent=fmtMiles(c.mileage||0);
      const line2=document.createElement('div'); line2.className='line'; line2.innerHTML=`<b class='price'>${fmtPrice(c.price||0)}</b><span class='muted' style='font-size:12px;color:#475569'>${c.addedAt? new Date(c.addedAt).toLocaleDateString():''}</span>`;
      line.appendChild(title); line.appendChild(miles); info.appendChild(line); info.appendChild(line2);
      const acts=document.createElement('div'); acts.className='actions';
      const editB=document.createElement('button'); editB.className='small'; editB.textContent='Edit'; editB.addEventListener('click', (e)=>{ e.stopPropagation(); openEdit(c.id); });
      const delB=document.createElement('button'); delB.className='small'; delB.textContent='Delete'; delB.style.color='#ef4444'; delB.style.borderColor='#fecaca'; delB.addEventListener('click',(e)=>{ e.stopPropagation(); if(confirm('Delete this car?')){ cars=cars.filter(x=>x.id!==c.id); persist(); render(); if(editingId===c.id) resetForm(); } });
      acts.appendChild(editB); acts.appendChild(delB);
      el.appendChild(ph); el.appendChild(info); el.appendChild(acts);
      el.addEventListener('click', ()=>openEdit(c.id));
      return el; }

    function openEdit(id){ const c=cars.find(x=>x.id===id); if(!c) return; editingId=id; yearEl.value=c.year||''; modelEl.value=c.model||'Model 3'; trimEl.value=c.trim||''; mileageEl.value=c.mileage||''; priceEl.value=c.price||'';
      if(c.photo){ photoPreview.src=c.photo; photoPreview.style.display='block'; dropHint.style.display='none'; } else { photoPreview.src=''; photoPreview.style.display='none'; dropHint.style.display='block'; }
      deleteBtn.style.display='inline-flex'; window.scrollTo({top:0, behavior:'smooth'}); }

    function resetForm(){ editingId=null; yearEl.value=''; modelEl.value='Model 3'; trimEl.value=''; mileageEl.value=''; priceEl.value=''; photoPreview.src=''; photoPreview.style.display='none'; dropHint.style.display='block'; deleteBtn.style.display='none'; }

    async function onSave(){ const y=num(yearEl.value), m=modelEl.value, t=trimEl.value.trim(), mi=num(mileageEl.value), p=num(priceEl.value);
      if(!y){ alert('Enter Year (e.g., 2020)'); yearEl.focus(); return; }
      if(!m){ alert('Choose Model'); modelEl.focus(); return; }
      if(!t){ alert('Enter Trim'); trimEl.focus(); return; }
      if(!mi){ alert('Enter Mileage (numbers only)'); mileageEl.focus(); return; }
      if(!p){ alert('Enter Price (numbers only)'); priceEl.focus(); return; }
      const photo=photoPreview.src && photoPreview.style.display!=='none' ? photoPreview.src : '';
      if(!editingId){ cars.push({ id:id(), year:y, model:m, trim:t, mileage:mi, price:p, photo, addedAt:Date.now() }); }
      else { const i=cars.findIndex(x=>x.id===editingId); if(i!==-1){ const prev=cars[i]; cars[i]={...prev, year:y, model:m, trim:t, mileage:mi, price:p, photo}; } }
      persist(); render(); resetForm(); }

    function onDelete(){ if(!editingId) return; if(!confirm('Delete this car?')) return; cars=cars.filter(x=>x.id!==editingId); persist(); render(); resetForm(); }

    function exportJSON(){ const blob=new Blob([JSON.stringify(cars,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='inventory.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

    importFile.addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; try{ const t=await f.text(); const data=JSON.parse(t); if(!Array.isArray(data)) throw new Error('Invalid file'); cars=data; persist(); render(); alert('Imported.'); } catch(err){ alert('Import failed.'); } importFile.value=''; });
    clearAllBtn.addEventListener('click', ()=>{ if(!cars.length) return; if(!confirm('Clear ALL cars?')) return; cars=[]; persist(); render(); resetForm(); });
    drop.addEventListener('dragover',(e)=>{ e.preventDefault(); drop.style.background='#eef2ff'; }); drop.addEventListener('dragleave',()=>{ drop.style.background='#f8fafc'; });
    drop.addEventListener('drop', async (e)=>{ e.preventDefault(); drop.style.background='#f8fafc'; const file=e.dataTransfer.files[0]; if(!file) return; await handleFile(file); });
    photoInput.addEventListener('change', async (e)=>{ const file=e.target.files[0]; if(!file) return; await handleFile(file); });
    async function handleFile(file){ if(!file.type.startsWith('image/')){ alert('Please choose an image file'); return; } const dataUrl=await compress(file,1200,0.86); photoPreview.src=dataUrl; photoPreview.style.display='block'; dropHint.style.display='none'; }
    async function compress(file,maxW=1200,quality=0.86){ const img=await toImg(file); const scale=Math.min(1,maxW/img.width); const w=Math.round(img.width*scale); const h=Math.round(img.height*scale); const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h; const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h); return canvas.toDataURL('image/jpeg', quality); }
    function toImg(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=fr.result; }; fr.onerror=rej; fr.readAsDataURL(file); }); }
    function placeholder(){ const s=`<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600' viewBox='0 0 800 600'><rect width='800' height='600' fill='#e5e7eb'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#94a3b8' font-family='system-ui' font-size='28'>Photo</text></svg>`; return 'data:image/svg+xml;charset=utf-8,'+encodeURIComponent(s); }
    saveBtn.addEventListener('click', onSave); newBtn.addEventListener('click', resetForm); exportBtn.addEventListener('click', exportJSON);

    settingsBtn.addEventListener('click', ()=> settings.style.display = settings.style.display==='none' ? 'block' : 'none');
    const cfgKey='tesla_inv_cfg';
    function loadCfg(){ try{ return JSON.parse(localStorage.getItem(cfgKey)||'{}'); } catch{ return {}; } }
    function saveCfg(v){ localStorage.setItem(cfgKey, JSON.stringify(v)); }
    function saveToken(t){ sessionStorage.setItem('tesla_inv_token', t||''); }
    function loadToken(){ return sessionStorage.getItem('tesla_inv_token')||''; }

    (function init(){
      const cfg=loadCfg();
      ghUser.value = cfg.user||''; ghRepo.value = cfg.repo||''; ghBranch.value = cfg.branch||'main'; ghPath.value = cfg.path||'inventory.json';
      ghToken.value = loadToken();
      [ghUser,ghRepo,ghBranch,ghPath].forEach(el=> el.addEventListener('change', ()=>{
        const c=loadCfg(); c.user=ghUser.value.trim(); c.repo=ghRepo.value.trim(); c.branch=ghBranch.value.trim()||'main'; c.path=ghPath.value.trim()||'inventory.json'; saveCfg(c);
      }));
      ghToken.addEventListener('change', ()=> saveToken(ghToken.value.trim()));
    })();

    async function publish(){
      try{
        const user=ghUser.value.trim(), repo=ghRepo.value.trim(), branch=(ghBranch.value.trim()||'main'), path=(ghPath.value.trim()||'inventory.json');
        const token=ghToken.value.trim() || loadToken();
        if(!user || !repo || !token){ alert('Fill GitHub Username, Repo, and paste your token in Settings.'); settings.style.display='block'; return; }
        const api='https://api.github.com';
        const headers={ 'Authorization':'Bearer '+token, 'Accept':'application/vnd.github+json' };

        const bodyStr=JSON.stringify(cars, null, 2);
        const content=btoa(unescape(encodeURIComponent(bodyStr)));

        let sha=null;
        try{
          const r=await fetch(`${api}/repos/${user}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`, { headers });
          if(r.ok){ const j=await r.json(); sha=j.sha||null; }
        }catch(_){}

        const payload={ message:'Update inventory via Admin', content, branch };
        if(sha) payload.sha=sha;

        const r2=await fetch(`${api}/repos/${user}/${repo}/contents/${encodeURIComponent(path)}`, { method:'PUT', headers, body: JSON.stringify(payload) });
        if(!r2.ok){ throw new Error('GitHub API error: '+ await r2.text()); }
        alert('Published to GitHub. Refresh your viewer in a moment.');
      }catch(err){ alert(err.message||String(err)); }
    }
    publishBtn.addEventListener('click', publish);

    render();
  </script>
</body>
</html>
