<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Inventory Admin (Robust)</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#f6f7fb;color:#0f172a}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e2e8f0}
    .wrap{max-width:620px;margin:0 auto;padding:12px}
    h1{font-size:18px;margin:6px 0}
    .panel{background:#fff;border:1px solid #e2e8f0;border-radius:14px;box-shadow:0 8px 24px rgba(15,23,42,.06);padding:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    label{font-size:12px;color:#475569}
    input,select{height:40px;border:1px solid #e2e8f0;border-radius:12px;padding:0 10px;font-size:16px}
    .drop{position:relative;border:2px dashed #cbd5e1;border-radius:14px;padding:10px;min-height:140px;display:grid;place-items:center;background:#f8fafc}
    .drop input{position:absolute;inset:0;opacity:0;cursor:pointer}
    .drop img{max-width:100%;border-radius:10px;display:none}
    .btn{height:36px;padding:0 12px;border:1px solid #e2e8f0;border-radius:12px;background:#fff;cursor:pointer}
    .primary{background:#0ea5e9;color:#fff;border-color:transparent}
    .list{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:16px;box-shadow:0 8px 24px rgba(15,23,42,.06);overflow:hidden}
    .photo{width:100%;aspect-ratio:4/3;background:#e5e7eb}
    .photo img{width:100%;height:100%;object-fit:cover;display:block}
    .info{padding:10px 12px 12px;display:flex;flex-direction:column;gap:6px}
    .line{display:flex;align-items:baseline;justify-content:space-between;gap:10px;white-space:nowrap;overflow:hidden}
    .title{font-weight:600;overflow:hidden;text-overflow:ellipsis}
    .miles{color:#475569}
    .price{font-weight:700}
  </style>
</head>
<body>
  <header><div class="wrap"><h1>Inventory Admin</h1></div></header>
  <main class="wrap">
    <div class="panel">
      <div class="grid">
        <div><label>Year</label><input id="year" type="text" placeholder="2020"></div>
        <div><label>Model</label>
          <select id="model">
            <option value="Model 3">Model 3</option><option value="Model Y">Model Y</option>
            <option value="Model S">Model S</option><option value="Model X">Model X</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div style="grid-column:span 2"><label>Trim</label><input id="trim" type="text" placeholder="Standard Plus"></div>
        <div><label>Mileage</label><input id="mileage" type="text" placeholder="66000"></div>
        <div><label>Price (USD)</label><input id="price" type="text" placeholder="19000"></div>
      </div>
      <div style="margin-top:10px">
        <label>Photo (optional; auto-compress)</label>
        <div class="drop"><input id="photo" type="file" accept="image/*"><img id="preview" alt="preview"><div id="hint" style="color:#475569;font-size:14px">Tap to select</div></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button id="save" type="button" class="btn primary">Save</button>
        <button id="export" type="button" class="btn">Export inventory.json</button>
        <a class="btn" href="./index.html">View site</a>
      </div>
      <p style="color:#475569;font-size:13px;margin:8px 0 0">After you add/update cars, click <b>Export inventory.json</b> and upload it to your repo to publish.</p>
    </div>

    <div id="list" class="list"></div>
    <p id="empty" style="text-align:center;color:#475569;margin:12px 0">No cars yet.</p>
  </main>

  <script>
    const KEY='tesla_inventory_v1';
    let cars = load();
    const list=document.getElementById('list'), empty=document.getElementById('empty');
    const year=document.getElementById('year'), model=document.getElementById('model'), trim=document.getElementById('trim'), mileage=document.getElementById('mileage'), price=document.getElementById('price');
    const photo=document.getElementById('photo'), preview=document.getElementById('preview'), hint=document.getElementById('hint');
    document.getElementById('save').addEventListener('click', onSave);
    document.getElementById('export').addEventListener('click', onExport);
    photo.addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; const url = await compress(f,1200,0.86); preview.src=url; preview.style.display='block'; hint.style.display='none'; });

    function load(){ try { return JSON.parse(localStorage.getItem(KEY)||'[]'); } catch { return []; } }
    function persist(){ localStorage.setItem(KEY, JSON.stringify(cars)); }
    function id(){ return Math.random().toString(36).slice(2,10); }
    function fmtPrice(n){ try { return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(n);} catch { return '$'+(n||0);} }
    function fmtMiles(n){ try { return new Intl.NumberFormat('en-US').format(n)+' mi'; } catch { return (n||0)+' mi'; } }
    function num(v){ const s=String(v).replace(/[^0-9]/g,''); return s?parseInt(s,10):0; }

    function render(){ list.innerHTML=''; if(!cars.length){ empty.style.display='block'; return; } empty.style.display='none'; cars.sort((a,b)=>(a.addedAt||0)-(b.addedAt||0)||(a.year||0)-(b.year||0));
      cars.forEach(c=>{ const el=document.createElement('div'); el.className='card'; const ph=document.createElement('div'); ph.className='photo'; const img=document.createElement('img'); img.src=c.photo||placeholder(); img.alt=c.model; ph.appendChild(img);
        const info=document.createElement('div'); info.className='info'; const l1=document.createElement('div'); l1.className='line'; const t=document.createElement('div'); t.className='title'; t.textContent=`${c.year||''} ${c.model||''} ${c.trim||''}`.replace(/\s+/g,' ').trim();
        const m=document.createElement('div'); m.className='miles'; m.textContent=fmtMiles(c.mileage||0); l1.appendChild(t); l1.appendChild(m); const l2=document.createElement('div'); l2.className='line';
        l2.innerHTML=`<b class='price'>${fmtPrice(c.price||0)}</b><span style='color:#475569;font-size:12px'>${c.addedAt? new Date(c.addedAt).toLocaleDateString():''}</span>`; info.appendChild(l1); info.appendChild(l2); el.appendChild(ph); el.appendChild(info); list.appendChild(el); }); }

    function placeholder(){ const s=`<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600' viewBox='0 0 800 600'><rect width='800' height='600' fill='#e5e7eb'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#94a3b8' font-family='system-ui' font-size='28'>Photo</text></svg>`; return 'data:image/svg+xml;charset=utf-8,'+encodeURIComponent(s); }
    async function compress(file,maxW=1200,quality=0.86){ const img=await toImg(file); const scale=Math.min(1,maxW/img.width), w=Math.round(img.width*scale), h=Math.round(img.height*scale); const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); return c.toDataURL('image/jpeg',quality); }
    function toImg(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=fr.result; }; fr.onerror=rej; fr.readAsDataURL(file); }); }

    function onSave(){
      const y=num(year.value), t=trim.value.trim(), mi=num(mileage.value), p=num(price.value);
      if(!y){ alert('Enter a Year, e.g., 2020'); year.focus(); return; }
      if(!model.value){ alert('Choose a Model'); model.focus(); return; }
      if(!t){ alert('Enter a Trim'); trim.focus(); return; }
      if(!mi){ alert('Enter Mileage (numbers only)'); mileage.focus(); return; }
      if(!p){ alert('Enter Price (numbers only)'); price.focus(); return; }
      const entry={ id:id(), year:y, model:model.value, trim:t, mileage:mi, price:p, photo:preview.src||'', addedAt:Date.now() };
      cars.push(entry); persist(); render();
      year.value=''; model.value='Model 3'; trim.value=''; mileage.value=''; price.value=''; preview.src=''; preview.style.display='none'; hint.style.display='block'; year.focus();
    }

    function onExport(){ const blob=new Blob([JSON.stringify(cars,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='inventory.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

    render();
  </script>
</body>
</html>
