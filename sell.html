<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sell Your Car — VIN Scan</title>

<!-- OCR + Barcode libs (no server needed) -->
<link rel="preconnect" href="https://unpkg.com">
<script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://unpkg.com/@zxing/browser@latest"></script>

<style>
:root{
  --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#475569; --line:#e2e8f0;
  --accent:#0ea5e9; --ok:#16a34a; --danger:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
header{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line)}
.wrap{max-width:680px;margin:0 auto;padding:12px}
h1{font-size:20px;margin:6px 0}
.card{background:#fff;border:1px solid var(--line);border-radius:14px;overflow:hidden;margin-top:12px}
.card .hd{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line);background:#fafafa}
.card .bd{padding:12px}
label{font-size:12px;color:var(--muted)}
input,select,button{font:inherit}
input,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
button{height:40px;padding:0 14px;border:1px solid var(--line);background:#fff;border-radius:12px;cursor:pointer}
button.primary{background:var(--accent);color:#fff;border-color:transparent;font-weight:700}
.note{font-size:12px;color:#475569}
.success{color:var(--ok)} .error{color:var(--danger)}

/* Notice + footer */
.notice{background:#f8fafc;border-bottom:1px solid var(--line);color:#475569}
.notice .wrap{padding:8px 12px;font-size:12px}
.legal{border-top:1px solid var(--line);color:#64748b;background:#fff}
.legal .wrap{padding:16px 12px;font-size:12px;line-height:1.5}
.legal a{color:#3b82f6;text-decoration:none} .legal a:hover{text-decoration:underline}

/* Scanner UI */
#scanner{position:relative;background:#000;border-radius:12px;overflow:hidden;display:none;margin-top:8px}
#scanner video{width:100%;height:auto;display:block}
#overlay{position:absolute;inset:0;pointer-events:none;border:2px dashed rgba(255,255,255,.4);border-radius:12px;clip-path:inset(18% 18% 18% 18% round 12px)}
.scan-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.scan-row button{height:36px}
#zoomWrap{display:none;align-items:center;gap:6px}
#zoom{width:160px}

.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.actions{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>

<!-- small compliance + privacy line -->
<div class="notice"><div class="wrap">
  By appointment only. We purchase EVs for cash and connect sellers with buyers. <b>Privacy:</b> We only use your info to reply with an offer — <b>we never sell your data</b>.
</div></div>

<header>
  <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:8px">
    <h1>Sell Your Car</h1>
    <div class="actions">
      <a href="./share.html"><button>View Inventory</button></a>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- STEP 1: VIN only -->
  <div class="card" id="step1">
    <div class="hd"><b>Step 1 — Scan or enter your VIN</b><span class="note">17 characters (no I, O, Q)</span></div>
    <div class="bd">
      <label>VIN</label>
      <input id="vin" maxlength="17" placeholder="5YJ...">
      <div id="vinMsg" class="note" style="margin-top:6px"></div>

      <div class="scan-row">
        <button id="takePhoto" type="button">Take VIN photo (OCR)</button>
        <button id="pickPhoto" type="button">Choose VIN photo</button>
      </div>
      <div class="scan-row">
        <button id="startScan" type="button">Scan barcode / QR / PDF417</button>
        <button id="stopScan" type="button">Stop</button>
        <button id="torch" type="button" style="display:none">Flashlight</button>
        <span id="zoomWrap"><span class="note">Zoom</span> <input id="zoom" type="range" min="1" max="1" step="0.1"></span>
      </div>

      <div id="scanner">
        <video id="video" muted playsinline></video>
        <div id="overlay"></div>
      </div>

      <input id="fileCamera" type="file" accept="image/*" capture="environment" style="display:none">
      <input id="filePicker"  type="file" accept="image/*" style="display:none">
    </div>
  </div>

  <!-- STEP 2: show after valid VIN -->
  <div class="card" id="step2" hidden>
    <div class="hd"><b>Step 2 — Confirm vehicle & add mileage/condition</b><span id="decodeNote" class="note"></span></div>
    <div class="bd">
      <div class="row">
        <div>
          <label>Year</label>
          <input id="year" type="number" min="2008" max="2100" placeholder="2020">
        </div>
        <div>
          <label>Model</label>
          <select id="model">
            <option value="">Select…</option>
            <option>Model 3</option><option>Model Y</option><option>Model S</option><option>Model X</option>
            <option>Roadster</option><option>Cybertruck</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Mileage</label>
          <input id="miles" type="number" min="0" step="500" placeholder="66000">
        </div>
        <div>
          <label>Overall condition</label>
          <select id="condition">
            <option value="">Select…</option>
            <option>Excellent</option><option>Good</option><option>Fair</option><option>Needs work</option>
          </select>
        </div>
      </div>

      <div class="actions" style="margin-top:12px">
        <button id="nextContact" class="primary">Next</button>
      </div>
    </div>
  </div>

  <!-- STEP 3: contact + send -->
  <div class="card" id="step3" hidden>
    <div class="hd"><b>Step 3 — How can we reach you?</b><span class="note">SMS is fastest</span></div>
    <div class="bd">
      <div class="row">
        <div><label>Your name</label><input id="name" placeholder="First Last"></div>
        <div><label>Your phone</label><input id="phone" placeholder="(555) 555-5555"></div>
      </div>
      <div style="margin-top:10px">
        <label>Email (optional)</label><input id="email" type="email" placeholder="you@example.com">
      </div>

      <div class="actions" style="margin-top:12px">
        <button id="sendSms" class="primary">Text this info</button>
        <button id="copySummary">Copy summary</button>
      </div>
      <div id="sendMsg" class="note" style="margin-top:8px"></div>
    </div>
  </div>

</main>

<footer class="legal">
  <div class="wrap">
    <div><strong>Disclosure:</strong> Retail transactions are completed by our licensed partner, Waltons Auto Sales. Private-party transactions are between individual buyer and seller. We are not affiliated with Tesla, Inc.</div>
    <div style="margin-top:6px">© <span id="yr"></span> E.V. Exchange · <a href="./privacy.html">Privacy</a> · <a href="./terms.html">Terms</a></div>
  </div>
</footer>

<script>
document.getElementById('yr').textContent = new Date().getFullYear();

/* ---------- VIN helpers ---------- */
const translit = {A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8,J:1,K:2,L:3,M:4,N:5,P:7,R:9,S:2,T:3,U:4,V:5,W:6,X:7,Y:8,Z:9,0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9};
const weights = [8,7,6,5,4,3,2,10,0,9,8,7,6,5,4,3,2];
function cleanVIN(v){ return (v||'').toUpperCase().replace(/[^A-HJ-NPR-Z0-9]/g,''); } // exclude I,O,Q
function vinCheckDigit(v){
  v = cleanVIN(v); if(v.length!==17) return false;
  let sum=0; for(let i=0;i<17;i++){ const ch=v[i]; const val=translit[ch]; if(val===undefined) return false; sum += val * weights[i]; }
  const rem=sum%11; const check= rem===10 ? 'X' : String(rem); return v[8]===check;
}
function yearFromCode(c){ const map={A:2010,B:2011,C:2012,D:2013,E:2014,F:2015,G:2016,H:2017,J:2018,K:2019,L:2020,M:2021,N:2022,P:2023,R:2024,S:2025,T:2026,V:2027,W:2028,X:2029,Y:2030,1:2031,2:2032,3:2033,4:2034,5:2035,6:2036,7:2037,8:2038,9:2039}; return map[c]||''; }
function modelFromTeslaChar(c){ const m={'S':'Model S','3':'Model 3','X':'Model X','Y':'Model Y','R':'Roadster','C':'Cybertruck'}; return m[c]||''; }
function isTeslaWMI(w){ return ['5YJ','7SA','LRW','XP7'].includes(w); }
function decodeVIN(v){
  v=cleanVIN(v); if(v.length!==17) return {};
  const wmi=v.slice(0,3), year=yearFromCode(v[9])||'', modelChar=v[3], model=modelFromTeslaChar(modelChar);
  const make=isTeslaWMI(wmi)?'Tesla':''; return {make,year,model};
}

/* ---------- Step control ---------- */
const step1=document.getElementById('step1');
const step2=document.getElementById('step2');
const step3=document.getElementById('step3');
const decodeNote=document.getElementById('decodeNote');

const vinEl=document.getElementById('vin'), vinMsg=document.getElementById('vinMsg');
const yearEl=document.getElementById('year'), modelEl=document.getElementById('model');
const milesEl=document.getElementById('miles'), conditionEl=document.getElementById('condition');

vinEl.addEventListener('input', e=>{
  const v = cleanVIN(e.target.value); e.target.value = v;
  const ok = v.length===17 && vinCheckDigit(v);
  vinMsg.textContent = !v ? '' : (ok ? 'VIN looks valid ✔' : 'VIN format/check digit mismatch.');
  vinMsg.className = 'note ' + (ok ? 'success' : 'error');
  if(ok){ onValidVIN(v); }
});

function onValidVIN(v){
  // Fill and reveal Step 2
  const d = decodeVIN(v);
  if(d.year) yearEl.value = d.year;
  if(d.make==='Tesla'){ if(d.model) modelEl.value = d.model; else { const guess=modelFromTeslaChar(v[3]); if(guess) modelEl.value = guess; } }
  decodeNote.textContent = 'Auto-filled from VIN' + (d.year?` • ${d.year}`:'') + (d.model?` • ${d.model}`:'');
  step2.hidden = false;
  // scroll into view
  step2.scrollIntoView({behavior:'smooth',block:'start'});
}

/* ---------- OCR (printed VIN) ---------- */
function downscaleToDataURL(imgSrc,maxW=1600,maxH=1600){
  return new Promise(res=>{
    const img=new Image(); img.onload=()=>{
      let {width:w,height:h}=img; const r=Math.min(maxW/w,maxH/h,1);
      const cw=Math.round(w*r), ch=Math.round(h*r);
      const c=document.createElement('canvas'); c.width=cw; c.height=ch;
      c.getContext('2d').drawImage(img,0,0,cw,ch);
      res(c.toDataURL('image/jpeg',0.92));
    }; img.src=imgSrc;
  });
}
async function ocrVINFromFile(file){
  return new Promise((resolve,reject)=>{
    const rd=new FileReader();
    rd.onload=async ()=>{
      try{
        const dataUrl=await downscaleToDataURL(rd.result);
        const worker=Tesseract.createWorker();
        await worker.load(); await worker.loadLanguage('eng'); await worker.initialize('eng');
        await worker.setParameters({ tessedit_char_whitelist:'ABCDEFGHJKLMNPRSTUVWXYZ0123456789' });
        const { data }=await worker.recognize(dataUrl); await worker.terminate();
        const text=(data && data.text || '').toUpperCase();
        const candidates=(text.match(/[A-HJ-NPR-Z0-9]{17}/g)||[]).filter(v=>vinCheckDigit(v));
        const v = candidates[0] || ((text.match(/[A-HJ-NPR-Z0-9]{17}/)||[])[0]||'');
        resolve(v);
      }catch(err){ reject(err); }
    };
    rd.onerror=reject; rd.readAsDataURL(file);
  });
}
const fileCamera=document.getElementById('fileCamera');
const filePicker=document.getElementById('filePicker');
document.getElementById('takePhoto').onclick=()=>fileCamera.click();
document.getElementById('pickPhoto').onclick=()=>filePicker.click();
fileCamera.onchange=()=>handleVINPhoto(fileCamera.files && fileCamera.files[0]);
filePicker.onchange=()=>handleVINPhoto(filePicker.files && filePicker.files[0]);
async function handleVINPhoto(file){
  if(!file) return;
  vinMsg.textContent='Reading VIN from photo…'; vinMsg.className='note';
  try{
    const v=await ocrVINFromFile(file);
    if(v && v.length===17){ vinEl.value=v; vinEl.dispatchEvent(new Event('input')); }
    else{ vinMsg.textContent='Could not find a clear 17-character VIN in this photo.'; vinMsg.className='note error'; }
  }catch(e){ vinMsg.textContent='OCR error. Try a clearer photo of the VIN plate.'; vinMsg.className='note error'; }
}

/* ---------- Barcode/QR/PDF417 live scan ---------- */
let codeReader=null, scanning=false;
const scanner=document.getElementById('scanner'), video=document.getElementById('video');
const torchBtn=document.getElementById('torch'), zoomWrap=document.getElementById('zoomWrap'), zoom=document.getElementById('zoom');
document.getElementById('startScan').onclick=startBarcodeScan;
document.getElementById('stopScan').onclick=stopBarcodeScan;

async function startBarcodeScan(){
  if(scanning) return; scanning=true; scanner.style.display='block';
  try{
    if(!codeReader){ codeReader=new ZXingBrowser.BrowserMultiFormatReader(); }
    await codeReader.decodeFromVideoDevice(null,'video',(result)=>{
      if(result && result.text){
        const raw=result.text.toUpperCase();
        const m=raw.match(/[A-HJ-NPR-Z0-9]{17}/);
        const v=m?m[0]:'';
        if(v){ vinEl.value=v; vinEl.dispatchEvent(new Event('input')); stopBarcodeScan(); }
      }
    });
    setupTrackControls();
  }catch(e){ alert('Camera error: '+(e && e.message || e)); stopBarcodeScan(); }
}
function stopBarcodeScan(){
  try{ codeReader && codeReader.reset(); }catch(e){}
  const stream=video.srcObject; if(stream){ stream.getTracks().forEach(t=>t.stop()); video.srcObject=null; }
  scanner.style.display='none'; scanning=false;
}
async function setupTrackControls(){
  try{
    const stream=video.srcObject; if(!stream) return;
    const track=stream.getVideoTracks()[0]; const caps=track.getCapabilities?track.getCapabilities():{};
    if(caps.torch){
      torchBtn.style.display='inline-block'; let on=false;
      torchBtn.onclick=async()=>{ on=!on; try{ await track.applyConstraints({advanced:[{torch:on}]}); }catch(e){} torchBtn.textContent=on?'Flashlight (ON)':'Flashlight'; };
    }else{ torchBtn.style.display='none'; }
    if(caps.zoom){
      zoomWrap.style.display='inline-flex';
      zoom.min=caps.zoom.min||1; zoom.max=caps.zoom.max||5; zoom.step=caps.zoom.step||0.1; zoom.value=caps.zoom.min||1;
      zoom.oninput=async()=>{ try{ await track.applyConstraints({advanced:[{zoom:+zoom.value}]}); }catch(e){} };
    }else{ zoomWrap.style.display='none'; }
  }catch(e){}
}

/* ---------- Step 3 + actions ---------- */
document.getElementById('nextContact').onclick=()=>{ step3.hidden=false; step3.scrollIntoView({behavior:'smooth',block:'start'}); };

function fmt(n){ try{ return new Intl.NumberFormat('en-US').format(+n||0); }catch{ return String(n||''); } }
function buildSummary(){
  const v=vinEl.value.trim().toUpperCase();
  const y=yearEl.value.trim(), m=modelEl.value.trim(), mi=milesEl.value.trim(), c=conditionEl.value.trim();
  const name=(document.getElementById('name').value||'').trim();
  const phone=(document.getElementById('phone').value||'').trim();
  const email=(document.getElementById('email').value||'').trim();
  const valid= v && v.length===17 && vinCheckDigit(v);
  const lines=[
    `SELL lead${valid?' (VIN ✔)':''}`,
    `VIN: ${v||'-'}`,
    `Year/Model: ${[y,m].filter(Boolean).join(' ')||'-'}`,
    `Mileage: ${mi?fmt(mi)+' mi':'-'} | Condition: ${c||'-'}`,
    `Name: ${name||'-'} | Phone: ${phone||'-'}${email?(' | Email: '+email):''}`
  ];
  return lines.join('\n');
}
async function copyText(t){
  try{ await navigator.clipboard.writeText(t); }
  catch{
    const ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); ta.remove();
  }
}
document.getElementById('sendSms').onclick=()=>{
  const msg=buildSummary();
  const dest="+14244256211"; // your receiving number
  copyText(msg); // convenience fallback
  location.href=`sms:${dest.replace(/[^0-9+]/g,'')}?&body=${encodeURIComponent(msg)}`;
};
document.getElementById('copySummary').onclick=async()=>{ await copyText(buildSummary()); const s=document.getElementById('sendMsg'); s.textContent='Summary copied.'; setTimeout(()=>s.textContent='',1500); };
</script>
</body>
</html>
