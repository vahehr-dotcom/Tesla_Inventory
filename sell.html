<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sell Your Tesla</title>
<link rel="preconnect" href="https://unpkg.com">
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
<style>
:root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#475569;--line:#e2e8f0;--accent:#0ea5e9;--danger:#ef4444}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
header{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line)}
.wrap{max-width:620px;margin:0 auto;padding:12px}
h1{font-size:20px;margin:6px 0}
small.muted{color:var(--muted)}
.card{background:#fff;border:1px solid var(--line);border-radius:14px;overflow:hidden;margin-top:12px}
.card .hd{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line);background:#fafafa}
.card .bd{padding:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
label{font-size:12px;color:var(--muted)}
input,select,textarea,button{font:inherit}
input,select,textarea{width:100%;padding:9px;border:1px solid var(--line);border-radius:10px;background:#fff}
textarea{min-height:80px;resize:vertical}
.actions{display:flex;flex-wrap:wrap;gap:8px}
button{height:40px;padding:0 14px;border:1px solid var(--line);background:#fff;border-radius:12px;cursor:pointer}
button.primary{background:var(--accent);color:#fff;border-color:transparent;font-weight:700}
button.warn{border-color:var(--danger);color:#ef4444}
#scanner{position:relative;background:#000;border-radius:12px;overflow:hidden;display:none}
#scanner video{width:100%;height:auto;display:block}
.badge{display:inline-block;background:#e2e8f0;color:#334155;border-radius:999px;padding:2px 8px;font-size:12px}
.note{font-size:12px;color:#475569}
.success{color:#16a34a}
.error{color:#ef4444}
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:8px">
    <b>Sell Your Tesla</b>
    <div class="actions">
      <a href="./index.html"><button>View Inventory</button></a>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- Simple settings (local only) -->
  <div class="card">
    <div class="hd"><b>Settings</b><small class="muted">Saved only on this device</small></div>
    <div class="bd">
      <div class="row">
        <div>
          <label>Lead receiver (phone SMS)</label>
          <input id="destPhone" placeholder="+14244256211" value="+14244256211">
        </div>
        <div>
          <label>Optional: Form endpoint (Formspree)</label>
          <input id="formEndpoint" placeholder="https://formspree.io/f/xxxxx">
        </div>
      </div>
      <div class="actions" style="margin-top:8px">
        <button id="saveCfg">Save</button>
        <small id="cfgMsg" class="muted"></small>
      </div>
      <div class="note">If you add a Formspree endpoint, submissions will also POST there (SMS still opens so sellers can attach photos easily).</div>
    </div>
  </div>

  <!-- VIN + car info -->
  <div class="card">
    <div class="hd"><b>Vehicle</b><span class="badge">VIN scan + validation</span></div>
    <div class="bd">
      <div class="row">
        <div>
          <label>VIN (17 chars)</label>
          <input id="vin" maxlength="17" placeholder="5YJ...">
        </div>
        <div class="actions" style="align-items:end">
          <button id="scan" type="button">Scan VIN</button>
          <button id="stop" type="button">Stop</button>
        </div>
      </div>
      <div id="vinMsg" class="note"></div>
      <div id="scanner"><video muted playsinline></video></div>

      <div class="row" style="margin-top:10px">
        <div><label>Year</label><input id="year" type="number" min="2008" max="2100" placeholder="2020"></div>
        <div><label>Model</label>
          <select id="model">
            <option value="">Select…</option>
            <option>Model 3</option><option>Model Y</option><option>Model S</option><option>Model X</option>
            <option>Roadster</option><option>Cybertruck</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div><label>Trim</label><input id="trim" placeholder="Standard Plus / Long Range / Performance / Plaid"></div>
        <div><label>Mileage</label><input id="miles" type="number" min="0" step="500" placeholder="66000"></div>
      </div>
      <div class="row">
        <div><label>Asking Price (USD)</label><input id="price" type="number" min="0" step="100" placeholder="19000"></div>
        <div><label>ZIP</label><input id="zip" inputmode="numeric" placeholder="90210"></div>
      </div>
      <div class="row">
        <div><label>Condition</label>
          <select id="condition">
            <option value="">Select…</option>
            <option>Excellent</option><option>Good</option><option>Fair</option><option>Needs work</option>
          </select>
        </div>
        <div><label>Title status</label>
          <select id="title">
            <option value="">Select…</option>
            <option>Clean</option><option>Salvage</option><option>Rebuilt</option><option>Lien</option>
          </select>
        </div>
      </div>
      <div><label>Notes</label><textarea id="notes" placeholder="Color, options, accidents, FSD, features, issues…"></textarea></div>
    </div>
  </div>

  <!-- Seller contact -->
  <div class="card">
    <div class="hd"><b>Your Contact</b><small class="muted">So we can respond</small></div>
    <div class="bd">
      <div class="row">
        <div><label>Name</label><input id="name" placeholder="First Last"></div>
        <div><label>Phone</label><input id="phone" placeholder="(555) 555-5555"></div>
      </div>
      <div><label>Email</label><input id="email" type="email" placeholder="you@example.com"></div>
    </div>
  </div>

  <!-- Actions -->
  <div class="card">
    <div class="hd"><b>Send</b><small class="muted">Fastest: text us; or submit form if configured</small></div>
    <div class="bd">
      <div class="actions">
        <button id="sendSms" class="primary">Text this info</button>
        <button id="submitForm">Submit form</button>
        <button id="copySummary">Copy summary</button>
      </div>
      <div class="note" style="margin-top:8px">After sending, reply to our text with photos of your car (exterior/interior, odometer, VIN sticker).</div>
      <div id="sendMsg" class="note"></div>
    </div>
  </div>

</main>

<script>
/* ---------- tiny store for settings ---------- */
const cfg = {
  get phone(){ return localStorage.getItem('sell_phone') || '+14244256211'; },
  set phone(v){ localStorage.setItem('sell_phone', v || ''); },
  get endpoint(){ return localStorage.getItem('sell_endpoint') || ''; },
  set endpoint(v){ localStorage.setItem('sell_endpoint', v || ''); }
};
document.getElementById('destPhone').value = cfg.phone;
document.getElementById('formEndpoint').value = cfg.endpoint;
document.getElementById('saveCfg').onclick = ()=>{
  cfg.phone = document.getElementById('destPhone').value.trim();
  cfg.endpoint = document.getElementById('formEndpoint').value.trim();
  document.getElementById('cfgMsg').textContent = 'Saved.';
  setTimeout(()=>document.getElementById('cfgMsg').textContent='', 1500);
};

/* ---------- VIN tools ---------- */
const translit = {A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8,J:1,K:2,L:3,M:4,N:5,P:7,R:9,S:2,T:3,U:4,V:5,W:6,X:7,Y:8,Z:9,
  0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9};
const weights = [8,7,6,5,4,3,2,10,0,9,8,7,6,5,4,3,2];
function cleanVIN(v){ return (v||'').toUpperCase().replace(/[^A-HJ-NPR-Z0-9]/g,''); } // no I,O,Q
function vinCheckDigit(v){
  v = cleanVIN(v);
  if(v.length!==17) return false;
  let sum=0;
  for(let i=0;i<17;i++){
    const ch=v[i]; const val=translit[ch]; if(val===undefined) return false;
    sum += val * weights[i];
  }
  const rem = sum % 11;
  const check = rem===10 ? 'X' : String(rem);
  return v[8]===check;
}
function vinStatus(v){
  v=cleanVIN(v);
  if(!v) return '';
  if(v.length<17) return 'Enter full 17-character VIN.';
  return vinCheckDigit(v) ? 'VIN looks valid ✔' : 'VIN format/check digit mismatch.';
}

/* ---------- VIN scanner (Quagga, Code39/128) ---------- */
let scanning=false;
const scanner = document.getElementById('scanner');
document.getElementById('scan').onclick = ()=>{
  if(scanning) return;
  scanning=true; scanner.style.display='block';
  Quagga.init({
    inputStream:{ name:"Live", type:"LiveStream", target:scanner, constraints:{ facingMode:"environment" } },
    decoder:{ readers:["code_39_reader","code_128_reader"] },
    locate:true
  }, err=>{
    if(err){ scanning=false; scanner.style.display='none'; alert('Camera error: '+err); return; }
    Quagga.start();
  });
  Quagga.onDetected(onDetected);
};
document.getElementById('stop').onclick = stopScan;
function onDetected(res){
  const code = (res && res.codeResult && res.codeResult.code) || '';
  const vin = cleanVIN(code);
  if(vin.length===17){
    document.getElementById('vin').value = vin;
    document.getElementById('vinMsg').textContent = vinStatus(vin);
    stopScan();
  }
}
function stopScan(){ if(!scanning) return; Quagga.stop(); Quagga.offDetected(onDetected); scanner.style.display='none'; scanning=false; }

/* ---------- live VIN validation ---------- */
document.getElementById('vin').addEventListener('input', e=>{
  const v = cleanVIN(e.target.value);
  e.target.value = v;
  document.getElementById('vinMsg').innerHTML = vinStatus(v);
  if(v.length===17 && vinCheckDigit(v)) document.getElementById('vinMsg').className='note success';
  else document.getElementById('vinMsg').className='note error';
});

/* ---------- summary / actions ---------- */
function fmt(n){ try { return new Intl.NumberFormat('en-US').format(+n||0); } catch{ return String(n||''); } }
function buildSummary(){
  const f = id=>document.getElementById(id).value.trim();
  const vin=f('vin'), year=f('year'), model=f('model'), trim=f('trim'), miles=f('miles'), price=f('price');
  const zip=f('zip'), cond=f('condition'), title=f('title');
  const name=f('name'), phone=f('phone'), email=f('email'), notes=f('notes');
  const validVIN = vin && vin.length===17 && vinCheckDigit(vin);
  const header = `New SELL lead${validVIN?' (VIN ✔)':''}`;
  const lines=[
    header,
    `VIN: ${vin||'-'}`,
    `Year/Model/Trim: ${[year,model,trim].filter(Boolean).join(' ')||'-'}`,
    `Mileage: ${miles?fmt(miles)+' mi':'-'}`,
    `Asking: ${price?('$'+fmt(price)):'-'}`,
    `Condition: ${cond||'-'} | Title: ${title||'-'}`,
    `ZIP: ${zip||'-'}`,
    `Name: ${name||'-'} | Phone: ${phone||'-'} | Email: ${email||'-'}`,
    `Notes: ${notes||'-'}`
  ];
  return lines.join('\n');
}

async function copyText(t){
  try{ await navigator.clipboard.writeText(t); }
  catch{
    const ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); ta.remove();
  }
}

/* SMS: opens seller's default messenger to your number with prefilled text */
document.getElementById('sendSms').onclick = ()=>{
  const msg=buildSummary();
  const dest=(document.getElementById('destPhone').value||cfg.phone||'').replace(/[^0-9+]/g,'');
  if(!dest){ alert('Set your SMS number in Settings.'); return; }
  copyText(msg); // helpful so they can paste if needed
  location.href = `sms:${dest}?&body=${encodeURIComponent(msg)}`;
};

/* Optional: POST to Formspree endpoint if configured */
document.getElementById('submitForm').onclick = async ()=>{
  const endpoint = (document.getElementById('formEndpoint').value||'').trim();
  const msgEl = document.getElementById('sendMsg');
  if(!endpoint){ msgEl.textContent='No endpoint set. Add a Formspree endpoint in Settings, or use Text this info.'; return; }
  const payload = {
    vin: document.getElementById('vin').value.trim(),
    year: document.getElementById('year').value.trim(),
    model: document.getElementById('model').value.trim(),
    trim: document.getElementById('trim').value.trim(),
    miles: document.getElementById('miles').value.trim(),
    price: document.getElementById('price').value.trim(),
    zip: document.getElementById('zip').value.trim(),
    condition: document.getElementById('condition').value.trim(),
    title: document.getElementById('title').value.trim(),
    name: document.getElementById('name').value.trim(),
    phone: document.getElementById('phone').value.trim(),
    email: document.getElementById('email').value.trim(),
    notes: document.getElementById('notes').value.trim(),
    summary: buildSummary()
  };
  try{
    const r = await fetch(endpoint, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(r.ok){ msgEl.textContent='Submitted. We\'ll contact you shortly.'; msgEl.className='note success'; }
    else{ msgEl.textContent='Submit failed. Try SMS instead.'; msgEl.className='note error'; }
  }catch(e){
    msgEl.textContent='Network error. Try SMS instead.'; msgEl.className='note error';
  }
};

/* Copy summary (for manual paste into text/email) */
document.getElementById('copySummary').onclick = async ()=>{
  await copyText(buildSummary());
  const el=document.getElementById('sendMsg'); el.textContent='Summary copied.'; setTimeout(()=>el.textContent='',1500);
};
</script>
</body>
</html>
