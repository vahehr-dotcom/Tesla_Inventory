<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sell Your Tesla</title>

<!-- OCR + Barcode libs (UMD, no build tools needed) -->
<link rel="preconnect" href="https://unpkg.com">
<script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://unpkg.com/@zxing/browser@latest"></script>

<style>
:root{
  --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#475569; --line:#e2e8f0;
  --accent:#0ea5e9; --danger:#ef4444; --ok:#16a34a;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
header{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line)}
.wrap{max-width:680px;margin:0 auto;padding:12px}
h1{font-size:20px;margin:6px 0}
small.muted{color:var(--muted)}
.card{background:#fff;border:1px solid var(--line);border-radius:14px;overflow:hidden;margin-top:12px}
.card .hd{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line);background:#fafafa}
.card .bd{padding:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
label{font-size:12px;color:var(--muted)}
input,select,textarea,button{font:inherit}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
textarea{min-height:80px;resize:vertical}
.actions{display:flex;flex-wrap:wrap;gap:8px}
button{height:40px;padding:0 14px;border:1px solid var(--line);background:#fff;border-radius:12px;cursor:pointer}
button.primary{background:var(--accent);color:#fff;border-color:transparent;font-weight:700}
button.warn{border-color:var(--danger);color:#ef4444}
.badge{display:inline-block;background:#e2e8f0;color:#334155;border-radius:999px;padding:2px 8px;font-size:12px}
.note{font-size:12px;color:#475569}
.success{color:var(--ok)}
.error{color:var(--danger)}

/* Scanner UI */
#scanner{position:relative;background:#000;border-radius:12px;overflow:hidden;display:none;margin-top:8px}
#scanner video{width:100%;height:auto;display:block}
#overlay{position:absolute;inset:0;pointer-events:none;border:2px dashed rgba(255,255,255,.4);border-radius:12px;clip-path:inset(18% 18% 18% 18% round 12px)}
.scan-controls{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
.scan-controls button{height:36px}
#zoomWrap{display:none;align-items:center;gap:6px}
#zoom{width:160px}

/* Collapsible "More details" */
details>summary{cursor:pointer;list-style:none;padding:10px;border:1px dashed var(--line);border-radius:10px;background:#fafafa}
details>summary::marker, details>summary::-webkit-details-marker{display:none}
details[open]>summary{background:#eef6ff;border-color:#cfe4ff}
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:8px">
    <h1>Sell Your Tesla</h1>
    <div class="actions">
      <a href="./index.html"><button>View Inventory</button></a>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- Settings (local only) -->
  <div class="card">
    <div class="hd"><b>Settings</b><small class="muted">Saved only on this device</small></div>
    <div class="bd">
      <div class="row">
        <div>
          <label>Receive leads via SMS (your phone)</label>
          <input id="destPhone" placeholder="+14244256211" value="+14244256211">
        </div>
        <div>
          <label>Optional: Form endpoint (Formspree)</label>
          <input id="formEndpoint" placeholder="https://formspree.io/f/xxxxx">
        </div>
      </div>
      <div class="actions" style="margin-top:8px">
        <button id="saveCfg">Save</button>
        <small id="cfgMsg" class="muted"></small>
      </div>
      <div class="note">With a Formspree endpoint, submissions also POST there. SMS stays for quick photo replies.</div>
    </div>
  </div>

  <!-- Short form + universal VIN scanner -->
  <div class="card" id="formCard">
    <div class="hd"><b>Vehicle</b><span class="badge">Scan printed VIN, QR/Barcode, or type</span></div>
    <div class="bd">
      <div class="row">
        <div>
          <label>VIN (17 chars)</label>
          <input id="vin" maxlength="17" placeholder="5YJ...">
          <div id="vinMsg" class="note"></div>
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="scan-controls">
            <button id="takePhoto" type="button">Take VIN photo (OCR)</button>
            <button id="pickPhoto" type="button">Choose VIN photo</button>
          </div>
          <div class="scan-controls">
            <button id="startScan" type="button">Scan barcode / QR / PDF417</button>
            <button id="stopScan" type="button">Stop</button>
            <button id="torch" type="button" style="display:none">Flashlight</button>
            <span id="zoomWrap"><span class="note">Zoom</span> <input id="zoom" type="range" min="1" max="1" step="0.1"></span>
          </div>
          <input id="fileCamera" type="file" accept="image/*" capture="environment" style="display:none">
          <input id="filePicker"  type="file" accept="image/*" style="display:none">
        </div>
      </div>

      <div id="scanner">
        <video id="video" muted playsinline></video>
        <div id="overlay"></div>
      </div>

      <!-- Essentials -->
      <div class="row" style="margin-top:10px">
        <div><label>Year</label><input id="year" type="number" min="2008" max="2100" placeholder="2020"></div>
        <div><label>Model</label>
          <select id="model">
            <option value="">Select…</option>
            <option>Model 3</option><option>Model Y</option><option>Model S</option><option>Model X</option>
            <option>Roadster</option><option>Cybertruck</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div><label>Mileage</label><input id="miles" type="number" min="0" step="500" placeholder="66000"></div>
        <div><label>ZIP</label><input id="zip" inputmode="numeric" placeholder="90210"></div>
      </div>

      <!-- More (optional) -->
      <details style="margin-top:8px">
        <summary>More details (optional)</summary>
        <div class="row" style="margin-top:10px">
          <div><label>Trim</label><input id="trim" placeholder="Standard Plus / Long Range / Performance / Plaid"></div>
          <div><label>Asking Price (USD)</label><input id="price" type="number" min="0" step="100" placeholder="19000"></div>
        </div>
        <div class="row">
          <div><label>Condition</label>
            <select id="condition">
              <option value="">Select…</option>
              <option>Excellent</option><option>Good</option><option>Fair</option><option>Needs work</option>
            </select>
          </div>
          <div><label>Title status</label>
            <select id="title">
              <option value="">Select…</option>
              <option>Clean</option><option>Salvage</option><option>Rebuilt</option><option>Lien</option>
            </select>
          </div>
        </div>
        <div><label>Notes</label><textarea id="notes" placeholder="Color, options, accidents, FSD, features, issues…"></textarea></div>
      </details>

      <!-- Contact -->
      <div class="row" style="margin-top:10px">
        <div><label>Your name</label><input id="name" placeholder="First Last"></div>
        <div><label>Your phone</label><input id="phone" placeholder="(555) 555-5555"></div>
      </div>
      <div><label>Email (optional)</label><input id="email" type="email" placeholder="you@example.com"></div>

      <!-- Actions -->
      <div class="actions" style="margin-top:12px">
        <button id="sendSms" class="primary">Text this info</button>
        <button id="submitForm">Submit form</button>
        <button id="copySummary">Copy summary</button>
      </div>
      <div class="note" style="margin-top:8px">After sending, reply to our text with photos (exterior/interior, odometer, VIN sticker).</div>
      <div id="sendMsg" class="note"></div>
    </div>
  </div>

</main>

<script>
/* ---------- tiny store for settings ---------- */
const cfg = {
  get phone(){ return localStorage.getItem('sell_phone') || '+14244256211'; },
  set phone(v){ localStorage.setItem('sell_phone', v || ''); },
  get endpoint(){ return localStorage.getItem('sell_endpoint') || ''; },
  set endpoint(v){ localStorage.setItem('sell_endpoint', v || ''); }
};
destPhone.value = cfg.phone; formEndpoint.value = cfg.endpoint;
saveCfg.onclick = ()=>{
  cfg.phone = destPhone.value.trim();
  cfg.endpoint = formEndpoint.value.trim();
  cfgMsg.textContent = 'Saved.'; setTimeout(()=>cfgMsg.textContent='', 1500);
};

/* ---------- VIN helpers ---------- */
const translit = {A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8,J:1,K:2,L:3,M:4,N:5,P:7,R:9,S:2,T:3,U:4,V:5,W:6,X:7,Y:8,Z:9,
  0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9};
const weights = [8,7,6,5,4,3,2,10,0,9,8,7,6,5,4,3,2];
function cleanVIN(v){ return (v||'').toUpperCase().replace(/[^A-HJ-NPR-Z0-9]/g,''); } // exclude I,O,Q
function vinCheckDigit(v){
  v = cleanVIN(v); if(v.length!==17) return false;
  let sum=0; for(let i=0;i<17;i++){ const ch=v[i]; const val=translit[ch]; if(val===undefined) return false; sum += val * weights[i]; }
  const rem = sum % 11; const check = rem===10 ? 'X' : String(rem); return v[8]===check;
}
function yearFromCode(c){
  const map = {A:2010,B:2011,C:2012,D:2013,E:2014,F:2015,G:2016,H:2017,J:2018,K:2019,L:2020,M:2021,N:2022,P:2023,R:2024,S:2025,T:2026,V:2027,W:2028,X:2029,Y:2030,1:2031,2:2032,3:2033,4:2034,5:2035,6:2036,7:2037,8:2038,9:2039};
  return map[c]||'';
}
function modelFromTeslaChar(c){
  const m = { 'S':'Model S', '3':'Model 3', 'X':'Model X', 'Y':'Model Y', 'R':'Roadster', 'C':'Cybertruck' };
  return m[c]||'';
}
function isTeslaWMI(w){ return ['5YJ','7SA','LRW','XP7'].includes(w); } // common Tesla WMIs
function decodeVIN(v){
  v = cleanVIN(v); if(v.length!==17) return {};
  const wmi = v.slice(0,3), year = yearFromCode(v[9])||'', modelChar = v[3], model = modelFromTeslaChar(modelChar);
  const make = isTeslaWMI(wmi) ? 'Tesla' : '';
  return { make, year, model };
}

/* Live VIN validity message */
vin.addEventListener('input', e=>{
  const v = cleanVIN(e.target.value); e.target.value = v;
  const ok = v.length===17 && vinCheckDigit(v);
  vinMsg.textContent = !v ? '' : (ok ? 'VIN looks valid ✔' : 'VIN format/check digit mismatch.');
  vinMsg.className = 'note ' + (ok ? 'success' : 'error');
});

/* ---------- OCR (printed VIN) ---------- */
function downscaleToDataURL(imgSrc, maxW=1600, maxH=1600){
  return new Promise(res=>{
    const img=new Image(); img.onload=()=>{
      let {width:w,height:h}=img;
      const r=Math.min(maxW/w, maxH/h, 1); const cw=Math.round(w*r), ch=Math.round(h*r);
      const c=document.createElement('canvas'); c.width=cw; c.height=ch;
      const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,cw,ch);
      res(c.toDataURL('image/jpeg',0.92));
    }; img.src=imgSrc;
  });
}
async function ocrVINFromFile(file){
  return new Promise((resolve,reject)=>{
    const rd=new FileReader();
    rd.onload=async ()=>{
      try{
        const dataUrl = await downscaleToDataURL(rd.result);
        const worker = Tesseract.createWorker();
        await worker.load();
        await worker.loadLanguage('eng');
        await worker.initialize('eng');
        // Limit character set to VIN chars (no I,O,Q; allow 0-9 A-H J-N P R-Z)
        await worker.setParameters({ tessedit_char_whitelist:'ABCDEFGHJKLMNPRSTUVWXYZ0123456789' });
        const { data } = await worker.recognize(dataUrl);
        await worker.terminate();
        const text=(data && data.text || '').toUpperCase();
        const candidates = (text.match(/[A-HJ-NPR-Z0-9]{17}/g)||[]).filter(v=>vinCheckDigit(v));
        // If none valid by check digit, fall back to the first 17-char candidate
        const vin = candidates[0] || ((text.match(/[A-HJ-NPR-Z0-9]{17}/)||[])[0]||'');
        resolve(vin);
      }catch(err){ reject(err); }
    };
    rd.onerror=reject; rd.readAsDataURL(file);
  });
}
takePhoto.onclick = ()=> fileCamera.click();
pickPhoto.onclick = ()=> filePicker.click();
fileCamera.onchange = ()=> handleVINPhoto(fileCamera.files && fileCamera.files[0]);
filePicker.onchange = ()=> handleVINPhoto(filePicker.files && filePicker.files[0]);

async function handleVINPhoto(file){
  if(!file) return;
  vinMsg.textContent='Reading VIN from photo…'; vinMsg.className='note';
  try{
    const v = await ocrVINFromFile(file);
    if(v && v.length===17){
      vin.value = v; vin.dispatchEvent(new Event('input'));
      autoFillFromVIN(v);
    }else{
      vinMsg.textContent='Could not find a clear 17-character VIN in this photo.'; vinMsg.className='note error';
    }
  }catch(e){
    vinMsg.textContent='OCR error. Try a clearer photo of the VIN plate.'; vinMsg.className='note error';
  }
}

/* ---------- Barcode/QR/PDF417 scan ---------- */
let codeReader=null, scanning=false;
async function startBarcodeScan(){
  if(scanning) return; scanning=true; scanner.style.display='block';
  try{
    if(!codeReader){ codeReader = new ZXingBrowser.BrowserMultiFormatReader(); }
    await codeReader.decodeFromVideoDevice(null, 'video', (result, err)=>{
      if(result && result.text){
        const raw = result.text.toUpperCase();
        // Try to extract a VIN from the payload (handles QR/PDF417 contents too)
        const m = raw.match(/[A-HJ-NPR-Z0-9]{17}/);
        const v = m ? m[0] : '';
        if(v){
          vin.value = v; vin.dispatchEvent(new Event('input'));
          autoFillFromVIN(v);
          stopBarcodeScan();
        }
      }
    });
    setupTrackControls();
  }catch(e){
    alert('Camera error: '+ (e && e.message || e));
    stopBarcodeScan();
  }
}
function stopBarcodeScan(){
  try{ codeReader && codeReader.reset(); }catch(e){}
  const stream = video.srcObject; if(stream){ stream.getTracks().forEach(t=>t.stop()); video.srcObject=null; }
  scanner.style.display='none'; scanning=false;
}
startScan.onclick = startBarcodeScan;
stopScan.onclick = stopBarcodeScan;

/* Torch + Zoom if supported */
async function setupTrackControls(){
  try{
    const stream = video.srcObject;
    if(!stream) return;
    const track = stream.getVideoTracks()[0];
    const caps = track.getCapabilities ? track.getCapabilities() : {};
    // Torch
    if(caps.torch){
      torch.style.display='inline-block';
      let on=false; torch.onclick = async ()=>{ on=!on; try{ await track.applyConstraints({ advanced:[{ torch:on }] }); }catch(e){} torch.textContent = on?'Flashlight (ON)':'Flashlight'; };
    }else{ torch.style.display='none'; }
    // Zoom
    if(caps.zoom){
      zoomWrap.style.display='inline-flex';
      zoom.min = caps.zoom.min || 1; zoom.max = caps.zoom.max || 5; zoom.step = caps.zoom.step || 0.1; zoom.value = caps.zoom.min || 1;
      zoom.oninput = async ()=>{ try{ await track.applyConstraints({ advanced:[{ zoom:+zoom.value }] }); }catch(e){} };
    }else{ zoomWrap.style.display='none'; }
  }catch(e){}
}

/* ---------- Auto-fill from VIN ---------- */
function autoFillFromVIN(v){
  const d = decodeVIN(v);
  if(d.year){ year.value = d.year; }
  // Always set Tesla if WMI recognized
  if(d.make==='Tesla'){
    // Set model drop-down if known
    if(d.model){
      model.value = d.model;
    }else{
      // Try inference by 4th char fallback
      const mc = v[3]; const guess = modelFromTeslaChar(mc); if(guess) model.value = guess;
    }
  }
  vinMsg.textContent = 'Auto-filled from VIN' + (d.year?` • ${d.year}`:'') + (d.model?` • ${d.model}`:'');
  vinMsg.className = 'note success';
  // Focus seller inputs next
  miles.focus();
}

/* ---------- Summary + actions ---------- */
function fmt(n){ try { return new Intl.NumberFormat('en-US').format(+n||0); } catch{ return String(n||''); } }
function buildSummary(){
  const f = id=>document.getElementById(id).value.trim();
  const vinTxt=f('vin'), yearTxt=f('year'), modelTxt=f('model'), trimTxt=f('trim'), milesTxt=f('miles'), priceTxt=f('price');
  const zipTxt=f('zip'), condTxt=f('condition'), titleTxt=f('title');
  const nameTxt=f('name'), phoneTxt=f('phone'), emailTxt=f('email'), notesTxt=f('notes');
  const validVIN = vinTxt && vinTxt.length===17 && vinCheckDigit(vinTxt);
  const header = `New SELL lead${validVIN?' (VIN ✔)':''}`;
  const lines=[
    header,
    `VIN: ${vinTxt||'-'}`,
    `Year/Model: ${[yearTxt,modelTxt].filter(Boolean).join(' ')||'-'}`,
    `Mileage: ${milesTxt?fmt(milesTxt)+' mi':'-'} | ZIP: ${zipTxt||'-'}`,
    (trimTxt||priceTxt||condTxt||titleTxt)? `Trim: ${trimTxt||'-'} | Asking: ${priceTxt?('$'+fmt(priceTxt)):'-'} | Cond: ${condTxt||'-'} | Title: ${titleTxt||'-'}` : null,
    `Name: ${nameTxt||'-'} | Phone: ${phoneTxt||'-'}${emailTxt?(' | Email: '+emailTxt):''}`,
    notesTxt?`Notes: ${notesTxt}`:null
  ].filter(Boolean);
  return lines.join('\n');
}

async function copyText(t){
  try{ await navigator.clipboard.writeText(t); }
  catch{
    const ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); ta.remove();
  }
}

/* SMS to your phone (prefilled) */
sendSms.onclick = ()=>{
  const msg=buildSummary();
  const dest=(destPhone.value||cfg.phone||'').replace(/[^0-9+]/g,'');
  if(!dest){ alert('Set your SMS number in Settings.'); return; }
  copyText(msg); // helpful so they can paste if needed
  location.href = `sms:${dest}?&body=${encodeURIComponent(msg)}`;
};

/* Optional form POST (Formspree) */
submitForm.onclick = async ()=>{
  const endpoint = (formEndpoint.value||'').trim();
  const msgEl = sendMsg;
  if(!endpoint){ msgEl.textContent='No endpoint set. Add a Formspree endpoint in Settings, or use Text this info.'; return; }
  const payload = {
    vin: vin.value.trim(), year: year.value.trim(), model: model.value.trim(),
    trim: trim.value.trim(), miles: miles.value.trim(), price: price.value.trim(),
    zip: zip.value.trim(), condition: condition.value.trim(), title: title.value.trim(),
    name: name.value.trim(), phone: phone.value.trim(), email: email.value.trim(),
    notes: notes.value.trim(), summary: buildSummary()
  };
  try{
    const r = await fetch(endpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(r.ok){ msgEl.textContent='Submitted. We\'ll contact you shortly.'; msgEl.className='note success'; }
    else{ msgEl.textContent='Submit failed. Try SMS instead.'; msgEl.className='note error'; }
  }catch(e){ msgEl.textContent='Network error. Try SMS instead.'; msgEl.className='note error'; }
};

/* Copy summary (manual) */
copySummary.onclick = async ()=>{ await copyText(buildSummary()); sendMsg.textContent='Summary copied.'; setTimeout(()=>sendMsg.textContent='',1500); };
</script>
</body>
</html>
